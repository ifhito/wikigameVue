<script setup lang="ts">
// This starter template is using Vue 3 <script setup> SFCs
// Check out https://v3.vuejs.org/api/sfc-script-setup.html#sfc-script-setup
// DONE: ユーザ名とルーム名を設定して、通信できるようにする
// DONE: コネクション削除時の通信処理

//TODO: refをreactiveでまとめる
import { ref,computed, watch} from 'vue';
import {useRoute} from 'vue-router';
import { useFixHTML } from '../customHooks';


const webSocket = ref<WebSocket>();
const gameStatus = ref<boolean>(false)
const answer = ref<string|null|undefined>('')
const winner = ref<string|null|undefined>('')
const defineWinner = ref<boolean>(false)
const connect = ref<boolean>(false);
const connectNum = ref<number>(0);
const errorMessage = ref<string>('');
const errorStatus = ref<boolean>(false);
const myNumber = ref<number>(0)
const nowNumber = ref<number>(0)
const nowName = ref<string>("")
const roomName = ref<string>('');
const name = ref<string>('');
const jsonBody = ref<string>('');
const submitUser = ref<string[]>([])

const {body, title, aList} = useFixHTML(jsonBody);

watch(title, () => {
    if (title.value === answer.value) {
        const msg = {
            command: "message",
            identifier: identifier,
            data: JSON.stringify({ action: "decied_winner", name: name.value }),
        };
        webSocket.value?.send(JSON.stringify(msg));
    }
})
const route =useRoute()
// ルームログインページからのルーム名と名前を保存する
roomName.value = route.query.roomName?.toString() ?? 'notRoomName'
name.value = route.query.name?.toString() ?? 'notName'
    
const delA = ['編集','英語版', '']
const identifier = JSON.stringify({
    channel: "WikiGameChannel",
    room: roomName.value,
    name: name.value,
});

// ボタンを押したときにその押された要素をバックエンドに伝える
const onClickSendText = (e) => {
    const msg = {
        command: 'message',
        identifier: identifier,
        data: JSON.stringify({action: "send_url", title: e.target.value, myNumber: myNumber.value, nextNumber: nowNumber.value}),
    };
    webSocket.value?.send(JSON.stringify(msg));
}

// ゲームをスタートする
const onClickStartGame = (e) => {
    gameStatus.value = true;
    const msg = {
        command: 'message',
        identifier: identifier,
        data: JSON.stringify({action: 'start_game'})
    };
    webSocket.value?.send(JSON.stringify(msg));
}

const switchAction = (message) => {
    console.log(message.action)
    switch(message.action){
        case 'error':
            errorStatus.value = true
            errorMessage.value = message.message
            break;
        case 'subscribed':
            connect.value = true
            if(!answer.value) answer.value = message.answerTitle.split(' - ')[0];
            submitUser.value = message.nameList
            myNumber.value = submitUser.value.indexOf(name.value)
            connectNum.value = message.connectNumber
            break;
        case 'start_game':
        case 'send_url':
            nowNumber.value = message.nextNumber
            nowName.value = message.nextName
            jsonBody.value = message.data
            gameStatus.value = true;    
            break;
        case 'decied_winner':
            winner.value = message.winner
            defineWinner.value = true
            break;
        default:
            return;
    }
}

// websocketの初期化
webSocket.value = new WebSocket("ws://localhost:3030/cable");

// websocketの通信開始
webSocket.value.onopen = () => {
    const msg = {
        command: 'subscribe',
        identifier: identifier
    }
    webSocket.value?.send(JSON.stringify(msg));
}

//websocket通信時のメッセージ受け取りを行う関数
webSocket.value.onmessage = async (e) => {
    // console.log(e.data)
    const data = await JSON.parse(e.data)
    switchAction(data.message)
};

// websocketの通信を閉じる
webSocket.value.close = () => {
    const msg = {
        command: 'message',
        identifier: identifier,
        data: JSON.stringify({action: "delete_user", myNumber: myNumber.value, nextNumber: nowNumber.value, nowName: nowName.value, myName: name.value})
    }
    webSocket.value?.send(JSON.stringify(msg));
}

// ブラウザが閉じる前にwebSocketをCloseする
window.onbeforeunload = () =>  {
    webSocket.value?.close();
};



</script>

<template>
<!-- エラー -->
  <div v-if="errorStatus">
  {{errorMessage}}
  </div>
  <!-- 通信中 -->
  <div v-else-if="!connect">
  通信中
  </div>
  <!-- ゲームスタート前 -->
  <div v-else-if="!gameStatus">
    <div>{{connectNum}}</div>
    <div>ルームID: {{roomName}}</div>
    <button @click="onClickStartGame">StartGame</button>
  </div>
  <div v-else-if="!defineWinner">
      <h1>{{title}}</h1>
      <template v-for="i in body.length" :key="`num_${i}`">
        <span v-html="body[i]"></span>
        <span v-if="name=== nowName">
        <button v-if="!(delA.includes(aList[i]) || /[*.]/.test(aList[i]))" :value="aList[i]" @click="onClickSendText">{{aList[i]}}</button>
        </span>
        <span v-else>
           <span v-if="!(delA.includes(aList[i]) || /[*.]/.test(aList[i]))" :value="aList[i]">{{aList[i]}}</span>
        </span>
      </template>
      <div>あなたの答え: {{answer}}</div>
      <div>現在のターン: {{nowName}}</div>
      <ul>
        <li v-for="user in submitUser" :key="user">
            {{user}}<span v-if="user === name">あなた</span>
        </li>
      </ul>
  </div>
  <div v-else>
    勝者は{{winner}}さんです
  </div>
</template>

<style>
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: #2c3e50;
  margin-top: 60px;
}
</style>
